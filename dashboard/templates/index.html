<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clopus Watcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body class="bg-neutral-950 text-white min-h-screen font-sans">
    <!-- Top Bar -->
    <header class="fixed top-0 left-0 right-0 h-14 bg-neutral-900 border-b border-neutral-800 z-50">
        <div class="h-full px-4 flex items-center justify-between">
            <span class="font-semibold text-lg">Clopus Watcher</span>
            <div class="flex items-center gap-4">
                <!-- Namespace Selector -->
                <select id="ns-select"
                        class="bg-neutral-800 border border-neutral-700 rounded px-3 py-1.5 text-sm focus:outline-none focus:border-neutral-600"
                        onchange="window.location.href='/?ns=' + this.value">
                    {{if not .Namespaces}}
                    <option value="">No namespaces yet</option>
                    {{else}}
                    {{range .Namespaces}}
                    <option value="{{.Namespace}}" {{if eq $.CurrentNS .Namespace}}selected{{end}}>{{.Namespace}}</option>
                    {{end}}
                    {{end}}
                </select>
                <!-- Stats -->
                {{if .Stats}}
                <div id="header-stats"
                     class="hidden sm:flex items-center gap-3 text-sm"
                     hx-get="/partials/stats?ns={{.CurrentNS}}"
                     hx-trigger="every 10s"
                     hx-swap="innerHTML">
                    <span class="text-neutral-500">Runs</span>
                    <span class="font-mono">{{.Stats.RunCount}}</span>
                    <span class="text-neutral-600">|</span>
                    <span class="text-emerald-500">{{.Stats.OkCount}} ok</span>
                    <span class="text-neutral-600">|</span>
                    <span class="text-amber-500">{{.Stats.FixedCount}} fixed</span>
                    <span class="text-neutral-600">|</span>
                    <span class="text-red-500">{{.Stats.FailedCount}} failed</span>
                </div>
                {{end}}
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="pt-14 flex h-screen">
        <!-- Runs Sidebar -->
        <aside class="w-64 lg:w-72 border-r border-neutral-800 flex flex-col bg-neutral-900">
            <div class="p-3 border-b border-neutral-800">
                <h2 class="text-xs font-semibold uppercase tracking-wider text-neutral-500">Runs</h2>
            </div>
            <div id="runs-list" class="flex-1 overflow-y-auto scrollbar-thin"
                 hx-get="/partials/runs?ns={{.CurrentNS}}"
                 hx-trigger="every 30s">
                {{template "runs-list.html" .}}
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0">
            {{if .SelectedRun}}
            <div id="run-detail" class="flex-1 overflow-y-auto">
                {{template "run-detail.html" (dict "Run" .SelectedRun "Fixes" .SelectedFixes)}}
            </div>
            {{else}}
            <div class="flex-1 flex items-center justify-center text-neutral-500">
                <div class="text-center">
                    <p class="text-lg mb-2">No runs yet</p>
                    <p class="text-sm text-neutral-600">Watcher runs every 5 minutes</p>
                </div>
            </div>
            {{end}}

            <!-- Live Log (collapsible) -->
            <div class="border-t border-neutral-800">
                <button onclick="toggleLog()" class="w-full px-4 py-2 flex items-center justify-between text-sm text-neutral-400 hover:bg-neutral-800/50">
                    <span>Live Terminal</span>
                    <svg id="log-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                </button>
                <div id="log-panel" class="hidden bg-neutral-950 border-t border-neutral-800">
                    <div id="live-log"
                         class="h-48 p-3 font-mono text-xs text-neutral-400 overflow-y-auto scrollbar-thin"
                         hx-get="/partials/log"
                         hx-trigger="every 3s"
                         hx-swap="innerHTML">
                        {{.Log}}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function toggleLog() {
            const panel = document.getElementById('log-panel');
            const chevron = document.getElementById('log-chevron');
            panel.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // Auto-scroll log
        const logContainer = document.getElementById('live-log');
        if (logContainer) {
            new MutationObserver(() => {
                logContainer.scrollTop = logContainer.scrollHeight;
            }).observe(logContainer, { childList: true });
        }

        // Helper for templates
        function dict(obj) { return obj; }
    </script>
</body>
</html>
